<!DOCTYPE html>
<html lang="fr-fr">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script>
  <link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> [C&#43;&#43;] Mouvement de cam√©ra SFML | Pierre Lefebvre</title>
  <link rel = 'canonical' href = '/code/camera-shake/'>
  <meta name="description" content="Ing√©nieur d√©veloppement Web, Atos (Lyon).">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="[C&#43;&#43;] Mouvement de cam√©ra SFML" />
<meta property="og:description" content="Secousse de cam√©ra avec SFML Dans cette pr√©sentation, Squirrel Eiserloh pr√©sente de fa√ßon g√©n√©rale comment ajouter des mouvements (translations fluides, secousses) √† la cam√©ra d&rsquo;une sc√®ne en deux ou trois dimensions. On se propose d&rsquo;appliquer cela sur un exemple de sc√®ne 2D √©crite en C&#43;&#43; avec SFML : l&rsquo;appui sur Espace d√©clenche une explosion qui fait vaciller la cam√©ra.
Le r√©sultat final ressemble √† ceci (la qualit√© est un peu d√©grad√©e par le format GIF) :" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/code/camera-shake/" /><meta property="article:section" content="code" />
<meta property="article:published_time" content="2022-03-10T14:44:50+01:00" />
<meta property="article:modified_time" content="2022-03-10T14:44:50+01:00" />


  <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="[C&#43;&#43;] Mouvement de cam√©ra SFML"/>
<meta name="twitter:description" content="Secousse de cam√©ra avec SFML Dans cette pr√©sentation, Squirrel Eiserloh pr√©sente de fa√ßon g√©n√©rale comment ajouter des mouvements (translations fluides, secousses) √† la cam√©ra d&rsquo;une sc√®ne en deux ou trois dimensions. On se propose d&rsquo;appliquer cela sur un exemple de sc√®ne 2D √©crite en C&#43;&#43; avec SFML : l&rsquo;appui sur Espace d√©clenche une explosion qui fait vaciller la cam√©ra.
Le r√©sultat final ressemble √† ceci (la qualit√© est un peu d√©grad√©e par le format GIF) :"/>

  
  
    
  
  
  <link rel="stylesheet" href="/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css" integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="/">
  
    <div id="logo" style="background-image: url(/images/logo.png)"></div>
  
  <div id="title">
    <h1>Pierre Lefebvre</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#" aria-label="Menu"><i class="fas fa-bars fa-2x" aria-hidden="true"></i></a>
      </li>
      
        <li><a href="/">Accueil</a></li>
      
        <li><a href="/resources">Ressources</a></li>
      
        <li><a href="/code">Code</a></li>
      
        <li><a href="/post">Design</a></li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <h1 id="secousse-de-cam√©ra-avec-sfml">Secousse de cam√©ra avec SFML</h1>
<p>Dans cette <a href="https://www.youtube.com/watch?v=tu-Qe66AvtY">pr√©sentation</a>, Squirrel Eiserloh pr√©sente de fa√ßon g√©n√©rale comment ajouter des mouvements (translations fluides, secousses) √† la cam√©ra d&rsquo;une sc√®ne en deux ou trois dimensions. On se propose d&rsquo;appliquer cela sur un exemple de sc√®ne 2D √©crite en C++ avec SFML : l&rsquo;appui sur <code>Espace</code> d√©clenche une explosion qui fait vaciller la cam√©ra.</p>
<p>Le r√©sultat final ressemble √† ceci (la qualit√© est un peu d√©grad√©e par le format GIF) :</p>
<p><img src="https://github.com/plefebvre91//sfml-camera-shake/raw/main/screenshot.gif" alt="Screenshot"></p>
<p>Le code final est disponible <a href="https://github.com/plefebvre91/sfml-camera-shake">ici</a>.</p>
<h2 id="m√©thode">M√©thode</h2>
<p>On se concentre ici sur les √©l√©ments permettant d&rsquo;ajouter une secousse √† la cam√©ra. Les autres aspects (<em>sprite</em> anim√©, gestion de fen√™tre SFML) ne seront pas abord√©s.</p>
<p>Dans le cas de la SFML, il n&rsquo;y a pas d&rsquo;objet <em>cam√©ra</em> √† part enti√®re et tout repose sur la gestion de la vue qu&rsquo;on pourra d√©placer ou faire tourner.</p>
<blockquote>
<p>üí° <strong>Note</strong>: L&rsquo;inexistence de l&rsquo;entit√© <em>cam√©ra</em> n&rsquo;est pas propre √† SFML. Avec OpenGL (et DirectX de ce que j&rsquo;en connais) c&rsquo;est la combinaison des diff√©rentes matrices de projection qui permet de calculer la vue.</p>
</blockquote>
<p>L&rsquo;id√©e est d&rsquo;appliquer des transformations assez rapides √† la vue (qu&rsquo;on appellera donc maintenant &ldquo;cam√©ra&rdquo;) pour donner l&rsquo;impression d&rsquo;une secousse.</p>
<h3 id="d√©finition-dune-animation">D√©finition d&rsquo;une animation</h3>
<p>Chaque secousse peut √™tre param√©tr√©e par une intensit√© (<code>trauma</code>), ainsi qu&rsquo;une dur√©e (<code>max</code>). L&rsquo;intensit√© d√©cro√Æt au cours du temps, ce qui permet de revenir √† un √©tat normal et stable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">CameraAnimation</span> {
</span></span><span style="display:flex;"><span>  sf<span style="color:#f92672">::</span>Time current;
</span></span><span style="display:flex;"><span>  sf<span style="color:#f92672">::</span>Time max;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">float</span> trauma;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>Le champ <code>current</code> servira √† conserver l&rsquo;avancement temporel de l&rsquo;animation entre deux appels √† la fonction de mise √† jour de la cam√©ra.</p>
<h3 id="la-cam√©ra">La cam√©ra</h3>
<p>La classe <code>Camera</code> propose les deux m√©thodes <code>shake()</code> et <code>update()</code> qui permettent respectivement d&rsquo;initier une secousse avec une intensit√© et une dur√©e donn√©es, et de mettre √† jour les propri√©t√©s de la cam√©ra (rotation, translation) √† chaque image.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Camera</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  Camera(sf<span style="color:#f92672">::</span>RenderWindow<span style="color:#f92672">*</span> window);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">shake</span>(<span style="color:#66d9ef">float</span> trauma, <span style="color:#66d9ef">float</span> duration_ms);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span>(<span style="color:#66d9ef">float</span> dt);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>Comme dit plus haut, les actions port√©es sur la cam√©ra sont en fait des actions port√©es sur la vue de la fen√™tre. On a donc besoin d&rsquo;une instance de la fen√™tre de rendu (pass√©e au constructeur).</p>
<h4 id="d√©clencher-la-secousse">D√©clencher la secousse</h4>
<p>La fonction <code>shake()</code> se contente de mettre √† jour les param√®tres souhait√©s pour la secousse en remplissant une structure (membre de la classe) de type <code>CameraAnimation</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> Camera<span style="color:#f92672">::</span>shake(<span style="color:#66d9ef">float</span> trauma, <span style="color:#66d9ef">float</span> duration_ms) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Set animation parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  _animation.max <span style="color:#f92672">=</span> sf<span style="color:#f92672">::</span>milliseconds(duration_ms);
</span></span><span style="display:flex;"><span>  _animation.current <span style="color:#f92672">=</span> sf<span style="color:#f92672">::</span>seconds(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Trauma is inscreased each time this function is called: several calls increase shaking
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  _animation.trauma <span style="color:#f92672">+=</span> trauma;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Elle peut par exemple √™tre appel√©e sur un √©v√®nement, ici ce sera l&rsquo;appui sur <code>Espace</code> qui d√©clenche une explosion.  √Ä noter que l&rsquo;intensit√© de la secousse peut √™tre augment√©e √† souhait en appelant plusieurs fois de suite la fonction.</p>
<h4 id="mise-√†-jour-de-la-vue">Mise √† jour de la vue</h4>
<p>La fonction <code>update()</code> est √† appeler dans la boucle principale, en m√™me temps que la mise √† jour des diff√©rentes entit√©s du jeu.</p>
<p>Elle calcule d&rsquo;abord un angle et un <em>offset</em> de d√©placement al√©atoires, et d√©pendant de l&rsquo;intensit√© souhait√©e.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#75715e">// ... otherwise compute a random angle...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">double</span> angle <span style="color:#f92672">=</span> CAMERA_SHAKE_ANGLE <span style="color:#f92672">*</span> _animation.trauma <span style="color:#f92672">*</span> randn();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ... and a random XY-offset...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>sf<span style="color:#f92672">::</span>Vector2f offset;
</span></span><span style="display:flex;"><span>offset.x <span style="color:#f92672">=</span> CAMERA_SHAKE_OFFSET <span style="color:#f92672">*</span> _animation.trauma <span style="color:#f92672">*</span> randn();
</span></span><span style="display:flex;"><span>offset.y <span style="color:#f92672">=</span> CAMERA_SHAKE_OFFSET <span style="color:#f92672">*</span> _animation.trauma <span style="color:#f92672">*</span> randn();
</span></span></code></pre></div><blockquote>
<p>üí° <strong>Note</strong>: <code>randn()</code> renvoie un nombre flottant entre -1 et 1</p>
</blockquote>
<p>Ensuite la transformation est appliqu√©e √† la cam√©ra.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#75715e">// ... and appply them to the view
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>_view.setRotation(angle);
</span></span><span style="display:flex;"><span>_view.setCenter(_center<span style="color:#f92672">+</span>offset);
</span></span><span style="display:flex;"><span>_window<span style="color:#f92672">-&gt;</span>setView(_view);
</span></span></code></pre></div><blockquote>
<p>üí° <strong>Note</strong>: le champ <code>_view</code> est initialis√© avec <code>window-&gt;getView()</code></p>
</blockquote>
<p>Puis le champ <code>current</code> de l&rsquo;animation est mis √† jour pour conserver l&rsquo;avancement, et enfin l&rsquo;intensit√© de la secousse est r√©duite de fa√ßon inversement proportionnelle au carr√© du temps √©coul√©.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#75715e">// Update animation time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>_animation.current <span style="color:#f92672">+=</span> sf<span style="color:#f92672">::</span>seconds(dt);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Decrease trauma parameter depending on time (squared)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">float</span> ratio <span style="color:#f92672">=</span> _animation.current.asSeconds() <span style="color:#f92672">/</span> _animation.max.asSeconds();
</span></span><span style="display:flex;"><span>_animation.trauma <span style="color:#f92672">*=</span> <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">-</span> ratio<span style="color:#f92672">*</span>ratio;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="utilisation">Utilisation</h3>
<p>L&rsquo;utilisation dans un programme SFML se fait de la fa√ßon suivante.</p>
<h4 id="instanciation">Instanciation</h4>
<p>La cam√©ra est instanci√©e en utilisant la fen√™tre de rendu.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span>sf<span style="color:#f92672">::</span>RenderWindow window(sf<span style="color:#f92672">::</span>VideoMode(<span style="color:#ae81ff">800</span>, <span style="color:#ae81ff">460</span>), <span style="color:#e6db74">&#34;SFML window&#34;</span>);
</span></span><span style="display:flex;"><span>Camera <span style="color:#a6e22e">camera</span>(<span style="color:#f92672">&amp;</span>window);
</span></span></code></pre></div><h4 id="mise-√†-jour">Mise √† jour</h4>
<p>La cam√©ra est mise √† jour √† chaque tour de la boucle principale.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#75715e">// Start the game loop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">while</span> (window.isOpen())
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Process events...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  camera.update(dt.asSeconds());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Draw things...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h4 id="secousse">Secousse</h4>
<p>Dans l&rsquo;exemple, la secousse se produit sur l&rsquo;appui sur la barre d&rsquo;espace.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (event.key.code <span style="color:#f92672">==</span> sf<span style="color:#f92672">::</span>Keyboard<span style="color:#f92672">::</span>Space)
</span></span><span style="display:flex;"><span>  camera.shake(<span style="color:#ae81ff">0.2</span>, <span style="color:#ae81ff">1200.0</span>);
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>On pourrait de la m√™me fa√ßon ajouter d&rsquo;autres effets de tremblements, d&rsquo;oscillations lentes, de translations. Le code final est disponible <a href="https://github.com/plefebvre91/sfml-camera-shake">ici</a>.</p>
<h2 id="ressources">Ressources</h2>
<ul>
<li>La <a href="https://www.youtube.com/watch?v=tu-Qe66AvtY">pr√©sentation</a> sur Youtube</li>
<li>Le <a href="https://github.com/plefebvre91/sfml-camera-shake">d√©p√¥t</a> Git du code</li>
</ul>

  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2024  Pierre Lefebvre 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Accueil</a></li>
         
        <li><a href="/resources">Ressources</a></li>
         
        <li><a href="/code">Code</a></li>
         
        <li><a href="/post">Design</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>
